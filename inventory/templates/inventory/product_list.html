{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="fw-bold mb-1 text-dark">Gestion du Stock</h4>
        <p class="text-muted small">Rotation des stocks et inventaire en temps réel.</p>
    </div>
    <div class="d-flex gap-2">
        {% if low_stock_count > 0 %}
        <div class="badge bg-danger-subtle text-danger p-2 px-3 rounded-pill d-flex align-items-center">
            <i class="fas fa-exclamation-triangle me-2 animate-pulse"></i>
            {{ low_stock_count }} Alertes Stock
        </div>
        {% endif %}
        <a href="{% url 'admin:inventory_product_add' %}" class="btn btn-primary btn-sm rounded-pill px-4 shadow-sm">
            <i class="fas fa-plus me-2"></i>Nouveau Produit
        </a>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm p-4 h-100">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h6 class="fw-bold text-uppercase small text-muted m-0">Top 5 - Rotation des stocks (Sorties)</h6>
                <i class="fas fa-chart-bar text-primary"></i>
            </div>
            <div style="height: 220px;">
                <canvas id="rotationChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card border-0 shadow-sm h-100 bg-primary text-white overflow-hidden" style="min-height: 200px;">
            <div class="card-body p-4 position-relative" style="z-index: 2;">
                <h6 class="text-uppercase small fw-bold opacity-75">Produit Star</h6>
                {% if top_data and top_data.0 > 0 %}
                    <h3 class="fw-bold mt-2 mb-1">{{ top_labels.0 }}</h3>
                    <p class="mb-0 opacity-75 small">
                        <i class="fas fa-arrow-trend-up me-1"></i> {{ top_data.0 }} unités écoulées
                    </p>
                {% else %}
                    <p class="mt-3 opacity-75 small">En attente de données de vente...</p>
                {% endif %}
                <div class="mt-4">
                    <a href="{% url 'inventory:stock-history' 1 %}" class="btn btn-sm btn-light rounded-pill px-3 fw-bold text-primary">Détails</a>
                </div>
            </div>
            <i class="fas fa-fire fa-6x position-absolute end-0 bottom-0 mb-n3 me-n2 opacity-25" style="transform: rotate(-15deg);"></i>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm p-3 border-start border-primary border-4">
            <small class="text-muted text-uppercase fw-bold" style="font-size: 0.65rem;">Total Références</small>
            <h3 class="fw-bold mb-0 mt-1">{{ total_products }}</h3>
        </div>
    </div>
</div>

<div class="row g-4" id="product-grid">
    {% for product in products %}
        <div class="col-md-4 col-lg-3" id="product-card-{{ product.pk }}">
            <div class="position-relative">
                {% if product.total_sales > 10 %}
                <span class="badge bg-warning text-dark position-absolute top-0 start-0 m-3 shadow-sm" style="z-index: 10; font-size: 0.65rem;">
                    <i class="fas fa-fire me-1"></i> POPULAIRE
                </span>
                {% endif %}
                {% include 'inventory/partials/product_card_inner.html' %}
            </div>
        </div>
    {% empty %}
        <div class="col-12 text-center py-5 text-muted">
            <i class="fas fa-box-open fa-3x mb-3 opacity-25"></i>
            <p>Aucun produit trouvé dans l'inventaire.</p>
        </div>
    {% endfor %}
</div>

<script>
    const rotCtx = document.getElementById('rotationChart').getContext('2d');
    
    // Gradient pour le graphique (Touche Senior Dev)
    const gradient = rotCtx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, '#4361ee');
    gradient.addColorStop(1, '#4361ee22');

    new Chart(rotCtx, {
        type: 'bar',
        data: {
            labels: {{ top_labels|safe }},
            datasets: [{
                label: 'Unités sorties',
                data: {{ top_data|safe }},
                backgroundColor: gradient,
                borderColor: '#4361ee',
                borderWidth: 1,
                borderRadius: 5,
                barPercentage: 0.6
            }]
        },
        options: {
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { 
                    beginAtZero: true, 
                    grid: { display: true, drawBorder: false, color: '#f0f0f0' },
                    ticks: { font: { size: 10 } }
                },
                x: { 
                    grid: { display: false },
                    ticks: { font: { size: 10, weight: '600' } }
                }
            }
        }
    });
</script>

<style>
    .hover-shadow:hover { transform: translateY(-8px); box-shadow: 0 15px 30px rgba(0,0,0,0.1) !important; }
    .transition { transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
    .animate-pulse { animation: pulse 2s infinite; }
    @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.05); opacity: 0.8; }
        100% { transform: scale(1); opacity: 1; }
    }
    .bg-danger-subtle { background-color: #fff5f5 !important; }
    .shadow-hover:hover { cursor: pointer; }
</style>
{% endblock content %}