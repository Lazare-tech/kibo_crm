{% extends 'base.html' %}

{% block content %}
<div class="row g-4 mb-4">
    <div class="col-md-4">
        <div class="card p-3 border-0 shadow-sm border-start border-success border-4 h-100">
            <div class="d-flex align-items-center">
                <div class="rounded-circle p-3 me-3 bg-success-subtle text-success">
                    <i class="fas fa-wallet fa-lg"></i>
                </div>
                <div>
                    <h6 class="text-muted mb-0 small text-uppercase fw-bold">CA Encaissé</h6>
                    <span class="h4 fw-bold mb-0 text-success">{{ total_encaisse }} FCFA</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card p-3 border-0 shadow-sm border-start border-warning border-4 h-100">
            <div class="d-flex align-items-center">
                <div class="rounded-circle p-3 me-3 bg-warning-subtle text-warning">
                    <i class="fas fa-file-invoice-dollar fa-lg"></i>
                </div>
                <div>
                    <h6 class="text-muted mb-0 small text-uppercase fw-bold">Factures en attente</h6>
                    <span class="h4 fw-bold mb-0 text-warning">{{ total_en_attente }} FCFA</span>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card p-3 border-0 shadow-sm border-start border-primary border-4 h-100">
            <div class="d-flex align-items-center">
                <div class="rounded-circle p-3 me-3 bg-primary-subtle text-primary">
                    <i class="fas fa-funnel-dollar fa-lg"></i>
                </div>
                <div>
                    <h6 class="text-muted mb-0 small text-uppercase fw-bold">Pipeline (Deals)</h6>
                    <span class="h4 fw-bold mb-0 text-primary">{{ total_pipeline }} FCFA</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-md-6">
        <div class="card p-3 border-0 shadow-sm h-100 d-flex flex-row align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <div class="rounded-circle p-2 me-3 bg-light text-muted">
                    <i class="fas fa-user-tie"></i>
                </div>
                <h6 class="text-muted m-0 small text-uppercase fw-bold">Volume Prospect : <span class="text-dark h5 ms-2">{{ total_leads }}</span></h6>
            </div>
            <a href="{% url 'leads:lead-create' %}" class="btn btn-sm btn-outline-primary rounded-pill">Nouveau prospect</a>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card p-3 border-0 shadow-sm h-100">
            <div class="d-flex justify-content-between align-items-center mb-1">
                <h6 class="text-muted m-0 small text-uppercase fw-bold">Objectif de conversion mensuel</h6>
                <span class="small fw-bold text-info">65%</span>
            </div>
            <div class="progress" style="height: 8px;">
                <div class="progress-bar bg-info" style="width: 65%"></div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-lg-4">
        <div class="card p-4 border-0 shadow-sm h-100">
            <h6 class="fw-bold mb-4 text-uppercase small text-muted">Répartition par Statut</h6>
            <div style="height: 250px;">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm p-4 h-100">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h6 class="fw-bold m-0 text-uppercase small text-muted">
                    <i class="fas fa-clock text-danger me-2"></i>Priorités du jour
                </h6>
                <span class="badge bg-danger-subtle text-danger">{{ urgent_tasks|length }} Urgences</span>
            </div>
            <div class="list-group list-group-flush">
                {% for task in urgent_tasks %}
                    <div class="list-group-item border-0 px-0 d-flex justify-content-between align-items-center hover-light rounded-3 p-2 mb-1">
                        <div>
                            <div class="fw-bold text-dark">{{ task.title }}</div>
                            <small class="text-muted">Prospect : <span class="text-primary">{{ task.lead.first_name }} {{ task.lead.last_name }}</span></small>
                        </div>
                        <a href="{% url 'leads:lead-detail' task.lead.pk %}" class="btn btn-sm btn-outline-primary rounded-pill">
                            Traiter <i class="fas fa-chevron-right ms-1"></i>
                        </a>
                    </div>
                {% empty %}
                    <div class="text-center py-5">
                        <i class="fas fa-check-circle text-success fs-1 mb-3"></i>
                        <p class="text-muted">Tout est à jour !</p>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
        <h5 class="fw-bold m-0">Action Commerciale Rapide</h5>
        <div class="input-group input-group-sm shadow-sm rounded-pill overflow-hidden bg-light" style="max-width: 300px;">
            <span class="input-group-text border-0 bg-light ps-3"><i class="fas fa-search text-muted small"></i></span>
            <input type="text" name="q" class="form-control border-0 bg-light" placeholder="Rechercher..."
                   hx-get="{% url 'leads:home' %}" hx-trigger="keyup changed delay:500ms" 
                   hx-target="#lead-table-body" hx-indicator=".htmx-indicator">
        </div>
    </div>
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="bg-light">
                <tr>
                    <th class="ps-4 border-0">Prospect</th>
                    <th class="border-0">Email</th>
                    <th class="border-0">Statut</th>
                    <th class="border-0">Source</th>
                    <th class="text-end pe-4 border-0">Actions</th>
                </tr>
            </thead>
            <tbody id="lead-table-body">
               {% include 'leads/partials/lead_list.html' %}
            </tbody>
        </table>
    </div>
</div>

<script>
    const ctx = document.getElementById('statusChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: {{ labels|safe }},
            datasets: [{
                data: {{ data|safe }},
                backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'],
                borderWidth: 0,
                hoverOffset: 10
            }]
        },
        options: {
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } }
            }
        }
    });
</script>
{% endblock content %}